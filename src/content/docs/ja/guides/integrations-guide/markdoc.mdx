---
type: integration
title: '@astrojs/markdoc'
description: AstroプロジェクトでMarkdocインテグレーションを使用する方法を学ぶ
sidebar:
  label: Markdoc
githubIntegrationURL: 'https://github.com/withastro/astro/tree/main/packages/integrations/markdoc/'
category: other
i18nReady: true
---
import { FileTree } from '@astrojs/starlight/components';
import PackageManagerTabs from '~/components/tabs/PackageManagerTabs.astro';
import { Steps } from '@astrojs/starlight/components';
import ReadMore from '~/components/ReadMore.astro';

この**[Astroインテグレーション][astro-integration]**により、[Markdoc](https://markdoc.dev/)を使用してコンポーネント、ページ、コンテンツコレクションエントリを作成できます。

## Markdocを使う理由

Markdocを使用すると、[Astroコンポーネント][astro-components]でMarkdownを拡張できます。Markdocで作成された既存のコンテンツがある場合、このインテグレーションによりコンテンツコレクションを使用してそれらのファイルをAstroプロジェクトに取り込むことができます。

## インストール

Astroには公式インテグレーションのセットアップを自動化する`astro add`コマンドが含まれています。お好みに応じて、代わりに[手動でインテグレーションをインストール](#手動インストール)することもできます。

新しいターミナルウィンドウで以下のコマンドのいずれかを実行してください。

<PackageManagerTabs>
  <Fragment slot="npm">
  ```sh
  npx astro add markdoc
  ```
  </Fragment>
  <Fragment slot="pnpm">
  ```sh
  pnpm astro add markdoc
  ```
  </Fragment>
  <Fragment slot="yarn">
  ```sh
  yarn astro add markdoc
  ```
  </Fragment>
</PackageManagerTabs>

問題が発生した場合は、[GitHubで問題を報告](https://github.com/withastro/astro/issues)し、以下の手動インストール手順を試してください。

### 手動インストール

まず、`@astrojs/markdoc`パッケージをインストールします。

<PackageManagerTabs>
  <Fragment slot="npm">
  ```sh
  npm install @astrojs/markdoc
  ```
  </Fragment>
  <Fragment slot="pnpm">
  ```sh
  pnpm add @astrojs/markdoc
  ```
  </Fragment>
  <Fragment slot="yarn">
  ```sh
  yarn add @astrojs/markdoc
  ```
  </Fragment>
</PackageManagerTabs>

次に、`integrations`プロパティを使用してインテグレーションを`astro.config.*`ファイルに適用します。

```js ins="markdoc()" title="astro.config.mjs" ins={2}
import { defineConfig } from 'astro/config';
import markdoc from '@astrojs/markdoc';
export default defineConfig({
  // ...
  integrations: [markdoc()],
});
```

### VS Codeエディター統合

VS Codeを使用している場合、構成されたタグの構文ハイライトとオートコンプリートを含む公式の[Markdoc言語拡張機能](https://marketplace.visualstudio.com/items?itemName=Stripe.markdoc-language-support)があります。詳細については、[GitHubの言語サーバー](https://github.com/markdoc/language-server.git)を参照してください。

拡張機能をセットアップするには、プロジェクトルートに以下の内容で`markdoc.config.json`ファイルを作成します。

```json title="markdoc.config.json"
[
  {
    "id": "my-site",
    "path": "src/content",
    "schema": {
      "path": "markdoc.config.mjs",
      "type": "esm",
      "property": "default",
      "watch": true
    }
  }
]
```

`markdoc.config.mjs`を`schema`オブジェクトを持つ設定ファイルとして設定し、`path`プロパティを使用してMarkdocファイルが保存されている場所を定義します。Markdocはコンテンツコレクション専用なので、`src/content`を使用できます。

## 使用方法

Markdocファイルはコンテンツコレクション内でのみ使用できます。`.mdoc`拡張子を使用してコンテンツコレクションにエントリを追加します。

<FileTree>
- src/
  - content/
    - docs/
      - why-markdoc.mdoc
      - quick-start.mdoc
</FileTree>

次に、[コンテンツコレクションAPI](/ja/guides/content-collections/#コレクションのクエリ)を使用してコレクションをクエリします。

```astro title="src/pages/why-markdoc.astro"
---
import { getEntry, render } from 'astro:content';

const entry = await getEntry('docs', 'why-markdoc');
const { Content } = await render(entry);
---

<!--フロントマタープロパティには`data`でアクセス-->
<h1>{entry.data.title}</h1>
<!--MarkdocコンテンツをContentコンポーネントでレンダリング-->
<Content />
```

<ReadMore>詳細については[Astroコンテンツコレクションドキュメント][astro-content-collections]を参照してください。</ReadMore>

## Markdoc変数を渡す

コンテンツに[変数][markdoc-variables]を渡す必要がある場合があります。これは、A/BテストなどのSSRパラメータを渡すときに役立ちます。

変数は`Content`コンポーネントを介してプロパティとして渡すことができます。

```astro title="src/pages/why-markdoc.astro"
---
import { getEntry, render } from 'astro:content';

const entry = await getEntry('docs', 'why-markdoc');
const { Content } = await render(entry);
---

<!--`abTest`パラメータを変数として渡す-->
<Content abTestGroup={Astro.params.abTestGroup} />
```

これで、`abTestGroup`は`docs/why-markdoc.mdoc`で変数として利用できます。

```md title="src/content/docs/why-markdoc.mdoc"
{% if $abTestGroup === 'image-optimization-lover' %}

画像最適化についてお話しします...

{% /if %}
```

すべてのMarkdocファイルでグローバルな変数を作成するには、`markdoc.config.mjs|ts`の`variables`属性を使用できます。

```js title="markdoc.config.mjs"
import { defineMarkdocConfig } from '@astrojs/markdoc/config';

export default defineMarkdocConfig({
  variables: {
    environment: process.env.IS_PROD ? 'prod' : 'dev',
  },
});
```

### Markdocコンテンツからフロントマターへのアクセス

フロントマターにアクセスするには、コンテンツをレンダリングする場所でエントリの`data`プロパティを変数として渡すことができます。

```astro title="src/pages/why-markdoc.astro"
---
import { getEntry, render } from 'astro:content';

const entry = await getEntry('docs', 'why-markdoc');
const { Content } = await render(entry);
---

<Content frontmatter={entry.data} />
```

これで、Markdocで`$frontmatter`としてアクセスできるようになります。

## コンポーネントをレンダリングする

`@astrojs/markdoc`は、Markdocのすべての機能を使用し、UIコンポーネントをコンテンツに接続するための設定オプションを提供します。

### AstroコンポーネントをMarkdocタグとして使用する

`.astro`コンポーネントにマップされる[Markdocタグ][markdoc-tags]を設定できます。プロジェクトのルートに`markdoc.config.mjs|ts`ファイルを作成し、`tag`属性を設定することで新しいタグを追加できます。

この例では`Aside`コンポーネントをレンダリングし、`type`プロパティを文字列として渡すことを許可します。

```js title="markdoc.config.mjs"
import { defineMarkdocConfig, component } from '@astrojs/markdoc/config';

export default defineMarkdocConfig({
  tags: {
    aside: {
      render: component('./src/components/Aside.astro'),
      attributes: {
        // Markdocでは各属性に型定義が必要です。
        // これらはレンダリングするコンポーネントの
        // `Props`型を反映する必要があります。
        // 属性定義については、Markdocのドキュメントを参照してください
        // https://markdoc.dev/docs/attributes#defining-attributes
        type: { type: String },
      },
    },
  },
});
```

このコンポーネントは、`{% aside %}`タグを使用してMarkdocファイルで使用できるようになりました。子要素はコンポーネントのデフォルトスロットに渡されます。

```md
# Markdocへようこそ 👋

{% aside type="tip" %}

このような洒落た「aside」タグを使用して、ドキュメントに_華やかさ_を追加してください。

{% /aside %}
```

### クライアントサイドUIコンポーネントを使用する

タグとノードは`.astro`ファイルに制限されています。MarkdocにクライアントサイドUIコンポーネントを埋め込むには、[希望の`client:`ディレクティブでフレームワークコンポーネントをレンダリングするラッパー`.astro`コンポーネントを使用](/ja/guides/framework-components/#フレームワークコンポーネントのネスト)してください。

この例では、React `Aside.tsx`コンポーネントを`ClientAside.astro`コンポーネントでラップします。

```astro title="src/components/ClientAside.astro"
---
import Aside from './Aside';
---

<Aside {...Astro.props} client:load />
```

このAstroコンポーネントは、設定内の任意の[タグ][markdoc-tags]または[ノード][markdoc-nodes]の`render`プロパティに渡すことができます。

```js title="markdoc.config.mjs"
import { defineMarkdocConfig, component } from '@astrojs/markdoc/config';

export default defineMarkdocConfig({
  tags: {
    aside: {
      render: component('./src/components/ClientAside.astro'),
      attributes: {
        type: { type: String },
      },
    },
  },
});
```

### npmパッケージとTypeScriptファイルからAstroコンポーネントを使用する

TypeScriptまたはJavaScriptファイルから名前付きエクスポートとして公開されたAstroコンポーネントを使用する必要がある場合があります。これは、npmパッケージとデザインシステムを使用する際によくあることです。

`component()`関数の第2引数としてインポート名を渡すことができます。

```js title="markdoc.config.mjs"
import { defineMarkdocConfig, component } from '@astrojs/markdoc/config';

export default defineMarkdocConfig({
  tags: {
    tabs: {
      render: component('@astrojs/starlight/components', 'Tabs'),
    },
  },
});
```

これにより、内部的に以下のインポート文が生成されます。

```ts
import { Tabs } from '@astrojs/starlight/components';
```

## Markdocパーシャル

`{% partial /%}`タグを使用すると、Markdocコンテンツ内で他の`.mdoc`ファイルをレンダリングできます。

これは、複数のドキュメント間でコンテンツを再利用するのに役立ち、コレクションスキーマに従わない`.mdoc`コンテンツファイルを持つことができます。

。。。tip
パーシャルファイルまたはディレクトリにはアンダースコア`_`プレフィックスを使用してください。これにより、パーシャルがコンテンツコレクションクエリから除外されます。
。。。

この例では、ブログコレクションエントリ内で使用するフッターのMarkdocパーシャルを示します。

```md title="src/content/blog/_footer.mdoc"
ソーシャルリンク:

- [Twitter / X](https://twitter.com/astrodotbuild)
- [Discord](https://astro.build/chat)
- [GitHub](https://github.com/withastro/astro)
```

`{% partial /%}`タグを使用してブログ投稿エントリの下部にフッターをレンダリングします。相対パスまたはインポートエイリアスを使用して、ファイルパスで`file`属性を適用します。

```md title="src/content/blog/post.mdoc" ins='file="_footer.mdoc"'
# 私のブログ投稿

{% partial file="./_footer.mdoc" /%}
```

## 構文ハイライト

`@astrojs/markdoc`は、コードブロックをハイライトするための[Shiki](https://shiki.style)と[Prism](https://github.com/PrismJS)拡張機能を提供します。

### Shiki

`extends`プロパティを使用してMarkdoc設定に`shiki()`拡張を適用します。オプションでshiki設定オブジェクトを渡すことができます。

```js title="markdoc.config.mjs"
import { defineMarkdocConfig } from '@astrojs/markdoc/config';
import shiki from '@astrojs/markdoc/shiki';

export default defineMarkdocConfig({
  extends: [
    shiki({
      // Shikiの組み込みテーマから選択（または独自のテーマを追加）
      // デフォルト: 'github-dark'
      // https://shiki.style/themes
      theme: 'dracula',
      // 水平スクロールを防ぐために単語ラップを有効にする
      // デフォルト: false
      wrap: true,
      // カスタム言語を渡す
      // 注意: Shikiには`.astro`を含む無数の言語が組み込まれています！
      // https://shiki.style/languages
      langs: [],
    }),
  ],
});
```

### Prism

`extends`プロパティを使用してMarkdoc設定に`prism()`拡張を適用します。

```js title="markdoc.config.mjs" ins={5}
import { defineMarkdocConfig } from '@astrojs/markdoc/config';
import prism from '@astrojs/markdoc/prism';

export default defineMarkdocConfig({
  extends: [prism()],
});
```

<ReadMore>Prismスタイルシートの設定について詳しくは、[構文ハイライトガイド](/ja/guides/syntax-highlighting/#prismスタイルシートを追加する)を参照してください。</ReadMore>

## カスタムMarkdocノード/要素

段落や太字テキストなどの標準的なMarkdown要素をAstroコンポーネントとしてレンダリングしたい場合があります。このために、[Markdocノード][markdoc-nodes]を設定できます。指定されたノードが属性を受け取る場合、それらはコンポーネントプロパティとして利用できます。

この例では、カスタム`Quote.astro`コンポーネントでブロッククォートをレンダリングします。

```js title="markdoc.config.mjs"
import { defineMarkdocConfig, nodes, component } from '@astrojs/markdoc/config';

export default defineMarkdocConfig({
  nodes: {
    blockquote: {
      ...nodes.blockquote, // 他のオプションにMarkdocのデフォルトを適用
      render: component('./src/components/Quote.astro'),
    },
  },
});
```

<ReadMore>すべての組み込みノードと属性について詳しくは、[Markdocノードドキュメント](https://markdoc.dev/docs/nodes#built-in-nodes)を参照してください。</ReadMore>

### カスタム見出し

`@astrojs/markdoc`は見出しにアンカーリンクを自動的に追加し、[コンテンツコレクションAPIを介して`headings`のリストを生成](/ja/guides/content-collections/#ボディコンテンツのレンダリング)します。見出しのレンダリング方法をさらにカスタマイズするには、[Markdocノード][markdoc-nodes]としてAstroコンポーネントを適用できます。

この例では、`render`プロパティを使用して`Heading.astro`コンポーネントをレンダリングします。

```js title="markdoc.config.mjs"
import { defineMarkdocConfig, nodes, component } from '@astrojs/markdoc/config';

export default defineMarkdocConfig({
  nodes: {
    heading: {
      ...nodes.heading, // デフォルトのアンカーリンク生成を保持
      render: component('./src/components/Heading.astro'),
    },
  },
});
```

すべてのMarkdown見出しは`Heading.astro`コンポーネントをレンダリングし、以下の`attributes`をコンポーネントプロパティとして渡します。

* `level: number` 見出しレベル1-6
* `id: string` 見出しのテキスト内容から生成された`id`。これは[コンテンツ`render()`関数](/ja/guides/content-collections/#ボディコンテンツのレンダリング)によって生成される`slug`に対応します。

例えば、見出し`### レベル3見出し！`は`level: 3`と`id: 'レベル3見出し'`をコンポーネントプロパティとして渡します。

### カスタム画像コンポーネント

Astroの`<Image />`コンポーネントはMarkdocで直接使用できません。ただし、ネイティブの`![]()`画像構文が使用されるたびにデフォルトの画像ノードをオーバーライドするようにAstroコンポーネントを設定したり、追加の画像属性を指定できるカスタムMarkdocタグとして使用したりできます。

#### Markdocのデフォルト画像ノードをオーバーライドする

デフォルトの画像ノードをオーバーライドするには、標準の`<img>`の代わりにレンダリングされる`.astro`コンポーネントを設定できます。

<Steps>
1. カスタム`MarkdocImage.astro`コンポーネントを構築して、画像から必要な`src`と`alt`プロパティを`<Image />`コンポーネントに渡します。

    ```astro title="src/components/MarkdocImage.astro"
    ---
    import { Image } from "astro:assets";
    interface Props {
      src: ImageMetadata;
      alt: string;
    }
    const { src, alt } = Astro.props;
    ---
    <Image src={src} alt={alt} />
    ```

2. `<Image />`コンポーネントは、`![]()`構文を使用して提供できないリモート画像に対して`width`と`height`を必要とします。リモート画像を使用する際のエラーを回避するには、リモートURL `src`が見つかった場合に標準のHTML `<img>`タグをレンダリングするようにコンポーネントを更新します。

    ```astro title="src/components/MarkdocImage.astro" ins="| string" del={9} ins={10-12}
    ---
    import { Image } from "astro:assets";
    interface Props {
      src: ImageMetadata | string;
      alt: string;
    }
    const { src, alt } = Astro.props;
    ---
    <Image src={src} alt={alt} />
    {
      typeof src === 'string' ? <img src={src} alt={alt} /> : <Image src={src} alt={alt} />
    }
    ```

3. デフォルトの画像ノードをオーバーライドして`MarkdocImage.astro`をレンダリングするようにMarkdocを設定します。

    ```js title="markdoc.config.mjs"
    import { defineMarkdocConfig, nodes, component } from '@astrojs/markdoc/config';

    export default defineMarkdocConfig({
      nodes: {
        image: {
          ...nodes.image, // 他のオプションにMarkdocのデフォルトを適用
          render: component('./src/components/MarkdocImage.astro'),
        },
      },
    });
    ```

4. `.mdoc`ファイルのネイティブ画像構文は、ローカル画像を最適化するために`<Image />`コンポーネントを使用するようになります。リモート画像は引き続き使用できますが、Astroの`<Image />`コンポーネントではレンダリングされません。

    ```md title="src/content/blog/post.mdoc"
    
    <!-- <Image />によって最適化 -->
    ![猫の写真](/cat.jpg)

    <!-- 最適化されていない<img> -->
    ![犬の写真](https://example.com/dog.jpg) 
    ```
</Steps>

#### カスタムMarkdoc画像タグを作成する

Markdoc `image`タグを使用すると、`![]()`構文では不可能な追加属性を画像に設定できます。例えば、カスタム画像タグを使用すると、`width`と`height`が必要なリモート画像にAstroの`<Image />`コンポーネントを使用できます。

以下の手順では、Astro `<Image />`コンポーネントを使用して画像を最適化し、キャプション付きの`<figure>`要素を表示するカスタムMarkdoc画像タグを作成します。

<Steps>
1. 必要なプロパティを受け取り、キャプション付きの画像をレンダリングする`MarkdocFigure.astro`コンポーネントを作成します。

    ```astro title="src/components/MarkdocFigure.astro"
    ---
    // src/components/MarkdocFigure.astro
    import { Image } from "astro:assets";

    interface Props {
      src: ImageMetadata | string;
      alt: string;
      width: number;
      height: number;
      caption: string;
    }

    const { src, alt, width, height, caption } = Astro.props;
    ---
    <figure>
        <Image {src} {alt} {width} {height}  />
        {caption && <figcaption>{caption}</figcaption>}
    </figure>
    ```

2. Astroコンポーネントをレンダリングするようにカスタム画像タグを設定します。

    ```ts title="markdoc.config.mjs"
    import { component, defineMarkdocConfig, nodes } from '@astrojs/markdoc/config';

    export default defineMarkdocConfig({
      tags: {
        image: {
          attributes: {
            width: {
              type: String,
            },
            height: {
              type: String,
            },
            caption: {
              type: String,
            },
            ...nodes.image.attributes
          },
          render: component('./src/components/MarkdocFigure.astro'),
        },
      },
    });
    ```

3. Markdocファイルで`image`タグを使用してキャプション付きの図を表示し、コンポーネントに必要なすべての属性を提供します。

    ```md
    {% image src="./astro-logo.png" alt="Astro Logo" width="100" height="100" caption="キャプション!" /%}
    ```
</Steps>

## 高度なMarkdoc設定

`markdoc.config.mjs|ts`ファイルは、[タグ](https://markdoc.dev/docs/tags)と[関数](https://markdoc.dev/docs/functions)を含む[すべてのMarkdoc設定オプション](https://markdoc.dev/docs/config)を受け入れます。

`markdoc.config.mjs|ts`ファイルのデフォルトエクスポートからこれらのオプションを渡すことができます。

```js title="markdoc.config.mjs"
import { defineMarkdocConfig } from '@astrojs/markdoc/config';

export default defineMarkdocConfig({
  functions: {
    getCountryEmoji: {
      transform(parameters) {
        const [country] = Object.values(parameters);
        const countryToEmojiMap = {
          japan: '🇯🇵',
          spain: '🇪🇸',
          france: '🇫🇷',
        };
        return countryToEmojiMap[country] ?? '🏳';
      },
    },
  },
});
```

これで、任意のMarkdocコンテンツエントリからこの関数を呼び出すことができます。

```md
¡Hola {% getCountryEmoji("spain") %}!
```

<ReadMore>コンテンツで変数や関数を使用する詳細については、[Markdocドキュメント](https://markdoc.dev/docs/functions#creating-a-custom-function)を参照してください。</ReadMore>

### ルートHTML要素を設定する

Markdocはデフォルトでドキュメントを`<article>`タグでラップします。これは`document` Markdocノードから変更できます。これはHTML要素名を受け入れるか、ラッパー要素を削除したい場合は`null`を受け入れます。

```js title="markdoc.config.mjs"
import { defineMarkdocConfig, nodes } from '@astrojs/markdoc/config';

export default defineMarkdocConfig({
  nodes: {
    document: {
      ...nodes.document, // 他のオプションにデフォルトを適用
      render: null, // デフォルト 'article'
    },
  },
});
```

## インテグレーション設定オプション

Astro Markdocインテグレーションは、`markdoc.config.js`ファイルでは利用できないMarkdocオプションと機能の設定を処理します。

### `allowHTML`

MarkdocタグとノードとともにHTMLマークアップの記述を有効にします。

デフォルトでは、MarkdocはHTMLマークアップをセマンティックコンテンツとして認識しません。

HTML要素をコンテンツとともに含めることができるよりMarkdownに近い体験を実現するには、`markdoc`インテグレーションオプションとして`allowHTML:true`を設定します。これにより、MarkdocマークアップでHTMLパーシングが有効になります。

```js ins="allowHTML: true" title="astro.config.mjs" ins={6}
  import { defineConfig } from 'astro/config';
  import markdoc from '@astrojs/markdoc';

  export default defineConfig({
    // ...
    integrations: [markdoc({ allowHTML: true })],
  });
```

。。。caution
`allowHTML`が有効になっている場合、Markdocドキュメント内のHTMLマークアップは（`<script>`を含む）実際のHTML要素としてレンダリングされ、XSSなどの攻撃ベクトルが可能になります。HTMLマークアップが信頼できるソースからのものであることを確認してください。
。。。

### `ignoreIndentation`

デフォルトでは、4つのスペースでインデントされたコンテンツはコードブロックとして扱われます。残念ながら、この動作により、複雑な構造を持つドキュメントの可読性を向上させるために任意レベルのインデントを使用することが困難になります。

Markdocでネストされたタグを使用する場合、タグ内のコンテンツをインデントして、深度レベルが明確になるようにすると役立ちます。任意のインデントをサポートするには、インデントベースのコードブロックを無効にし、インデントベースのコードブロックを考慮するその他のmarkdown-itパーシングルールを変更する必要があります。これらの変更は、ignoreIndentationオプションを有効にすることで適用できます。

```js "ignoreIndentation: true" title="astro.config.mjs" ins={6}
  import { defineConfig } from 'astro/config';
  import markdoc from '@astrojs/markdoc';

  export default defineConfig({
    // ...
    integrations: [markdoc({ ignoreIndentation: true })],
  });
```

```md
# インデントされたタグを使用したMarkdocへようこそ 👋

# 注意: インデントにはスペースまたはタブのいずれかを使用できます

{% custom-tag %}
{% custom-tag %} ### 可読性向上のためにタグをインデントできます

    {% another-custom-tag %}
      ネストが多い場合にこれは追跡しやすくなります
    {% /another-custom-tag %}

{% /custom-tag %}
{% /custom-tag %}
```

## 例

* [Astro Markdocスターターテンプレート](https://github.com/withastro/astro/tree/latest/examples/with-markdoc)は、AstroプロジェクトでMarkdocファイルを使用する方法を示しています。

[astro-integration]: /ja/guides/integrations-guide/

[astro-components]: /ja/basics/astro-components/

[astro-content-collections]: /ja/guides/content-collections/

[markdoc-tags]: https://markdoc.dev/docs/tags

[markdoc-nodes]: https://markdoc.dev/docs/nodes

[markdoc-variables]: https://markdoc.dev/docs/variables